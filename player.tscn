[gd_scene load_steps=16 format=3 uid="uid://bpq6s4m0iksd8"]

[ext_resource type="Texture2D" uid="uid://cypn8vg1l271j" path="res://textures/Tai/tai_16x16.png" id="2_ghijl"]
[ext_resource type="Texture2D" uid="uid://bbq11175iskqf" path="res://textures/Matt/matt_16x16.png" id="2_hqtel"]
[ext_resource type="Script" uid="uid://cqx5ai0w8rnjg" path="res://camera_2d.gd" id="3_ghijl"]
[ext_resource type="Texture2D" uid="uid://bh46vwg3li21c" path="res://textures/Teto/Teto_16x16.png" id="3_sweqy"]

[sub_resource type="GDScript" id="GDScript_ij6vw"]
script/source = "extends CharacterBody2D
class_name PlayerCharacter

@export var speed: float = 50.0
@export var block_diagonals: bool = true
@export var sprite_scale: float = 1.0
@export var digimon_group: StringName = \"Digimon\" # all your Pet/Enemy digimon are in this group

@export var skins: Array[Texture2D] = []

@onready var animation_player: AnimationPlayer = $AnimationPlayer/SpriteAnimationPlayer
@onready var sprite: Sprite2D = $AnimationPlayer

var current_skin_index: int = 0
var face_direction: String = \"Front\"
var animation_to_play: String = \"Front_Idle\"

func _ready() -> void:
	# Apply sprite scale
	sprite.scale = Vector2.ONE * sprite_scale

	if skins.is_empty():
		push_warning(\"PlayerCharacter: 'skins' array is empty â€“ assign some textures in the Inspector.\")
	else:
		_apply_skin_index(0)

	animation_player.stop()
	animation_player.play(\"Front_Idle\")

	# --- prevent collision with Digimon ---
	_ignore_digimon_collisions()


func _ignore_digimon_collisions() -> void:
	# Delay by one frame to ensure Digimon are ready
	await get_tree().process_frame
	for digimon in get_tree().get_nodes_in_group(digimon_group):
		if digimon is CharacterBody2D:
			add_collision_exception_with(digimon)
			digimon.add_collision_exception_with(self)


func _physics_process(_delta: float) -> void:
	if Input.is_action_just_pressed(\"swap_skin\") and skins.size() > 0:
		var next_index := (current_skin_index + 1) % skins.size()
		_apply_skin_index(next_index)

	var input_vector := Vector2.ZERO
	input_vector.x = Input.get_action_strength(\"ui_right\") - Input.get_action_strength(\"ui_left\")
	input_vector.y = Input.get_action_strength(\"ui_down\") - Input.get_action_strength(\"ui_up\")

	if block_diagonals and input_vector.x != 0.0 and input_vector.y != 0.0:
		if abs(input_vector.y) >= abs(input_vector.x):
			input_vector.x = 0.0
		else:
			input_vector.y = 0.0

	velocity = input_vector * speed

	if velocity.x < 0.0:
		face_direction = \"Left\"
	elif velocity.x > 0.0:
		face_direction = \"Right\"
	elif velocity.y < 0.0:
		face_direction = \"Back\"
	elif velocity.y > 0.0:
		face_direction = \"Front\"

	animation_to_play = face_direction + \"_\" + (\"Walk\" if velocity.length() > 0.0 else \"Idle\")
	if not animation_player.is_playing() or animation_player.current_animation != animation_to_play:
		animation_player.play(animation_to_play)

	move_and_slide()


func _apply_skin_index(index: int) -> void:
	if skins.is_empty():
		return
	current_skin_index = clamp(index, 0, skins.size() - 1)
	sprite.texture = skins[current_skin_index]
"

[sub_resource type="Animation" id="Animation_4sjlk"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 5), Vector2i(1, 5), Vector2i(2, 5), Vector2i(3, 5)]
}

[sub_resource type="Animation" id="Animation_ghijl"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 1), Vector2i(1, 1), Vector2i(2, 1), Vector2i(3, 1)]
}

[sub_resource type="Animation" id="Animation_lhvu3"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 4), Vector2i(1, 4), Vector2i(2, 4), Vector2i(3, 4)]
}

[sub_resource type="Animation" id="Animation_ij6vw"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 0), Vector2i(1, 0), Vector2i(2, 0), Vector2i(3, 0)]
}

[sub_resource type="Animation" id="Animation_6ct3r"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 7), Vector2i(1, 7), Vector2i(2, 7), Vector2i(3, 7)]
}

[sub_resource type="Animation" id="Animation_dd465"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 3), Vector2i(1, 3), Vector2i(2, 3), Vector2i(3, 3)]
}

[sub_resource type="Animation" id="Animation_qp52p"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 6), Vector2i(1, 6), Vector2i(2, 6), Vector2i(3, 6)]
}

[sub_resource type="Animation" id="Animation_44cfe"]
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:frame_coords")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.25, 0.5, 0.75),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [Vector2i(0, 2), Vector2i(1, 2), Vector2i(2, 2), Vector2i(3, 2)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_1kp85"]
_data = {
&"Back_Idle": SubResource("Animation_4sjlk"),
&"Back_Walk": SubResource("Animation_ghijl"),
&"Front_Idle": SubResource("Animation_lhvu3"),
&"Front_Walk": SubResource("Animation_ij6vw"),
&"Left_Idle": SubResource("Animation_6ct3r"),
&"Left_Walk": SubResource("Animation_dd465"),
&"Right_Idle": SubResource("Animation_qp52p"),
&"Right_Walk": SubResource("Animation_44cfe")
}

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_onrkg"]
radius = 1.0
height = 10.0

[node name="Player" type="CharacterBody2D"]
script = SubResource("GDScript_ij6vw")
skins = Array[Texture2D]([ExtResource("2_ghijl"), ExtResource("2_hqtel"), ExtResource("3_sweqy")])

[node name="AnimationPlayer" type="Sprite2D" parent="."]
texture = ExtResource("2_ghijl")
hframes = 4
vframes = 8
frame = 20

[node name="SpriteAnimationPlayer" type="AnimationPlayer" parent="AnimationPlayer"]
libraries = {
&"": SubResource("AnimationLibrary_1kp85")
}

[node name="Camera2D" type="Camera2D" parent="."]
script = ExtResource("3_ghijl")

[node name="PlayerCollision" type="CollisionShape2D" parent="."]
position = Vector2(0, 8)
rotation = 1.5707964
shape = SubResource("CapsuleShape2D_onrkg")
